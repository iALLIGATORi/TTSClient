using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Net.Http;
using System.Net.WebSockets;
using System.Text;
using System.Text.Json;
using System.Threading;
using System.Threading.Tasks;
using CloudTTS;
using NAudio.Wave;

namespace WSTTS
{
    class SynthesisWebsocket
    {
        public static async Task Synthesize(Task<string> sessionId, Task<Voices> voice)
        {
            using (var apiClient = new HttpClient())
            {
                apiClient.DefaultRequestHeaders.Add("X-Session-Id", sessionId.Result);
                var synthesizeWebText = new WebSocketTextParam();
                var synthesizeWebContent = new WebSocketRequest(voice, synthesizeWebText).ToJsonContent();
                var synthesizeWebResponse = await apiClient.PostAsync(
                    "https://cp.speechpro.com/vktts/rest/v1/synthesize/stream",
                    synthesizeWebContent);
                var urlString = synthesizeWebResponse.Content.ReadAsStringAsync().Result;
                var url = JsonSerializer.Deserialize<WebsocketUrl>(urlString);
                var uri = new Uri(url.Url);

                using (var apiWebsocketClient = new ClientWebSocket())
                {
                    await apiWebsocketClient.ConnectAsync(uri, CancellationToken.None);
                    Console.WriteLine("Введите текст для синтеза");
                    //while (apiWebsocketClient.State == WebSocketState.Open)
                    //{
                    var message = "В какой-то момент бедных стало слишком много. Чересчур. Какие-то люди. Другие. Нездешние. Просто люди — без имён, без ничего. Они роились повсюду. Всё делалось весьма тонко, — до ужаса тонко. Словно зараза распространялась по городам, заползала в дом, просачивалась сквозь двери. Никакой склеп не спасёт от могильных червей, не так ли? Это происходило повсюду, тысячами путей, бесчисленными способами, проверенными многократно и потому чрезвычайно надёжными. Они влезали к вам в кабинет сквозь щели почтовых ящиков — прося и требуя сейчас же помочь, пугая чудовищными картинами голода, взывая к жалости фотографиями большеглазых детей, провозглашая милосердие долгом, требуя и настаивая от имени и по поручению фондов и групп, прикрывающихся громкими именами, — день за днём, конверт за конвертом. Они ложились к вам на стол в образе утренней газеты, звенели в ушах проповедью вашего пастора, въедались в глаза хроникой из телевизора — бесчисленные факты нищеты, и вот вам уже никуда не деться от них. Они окружают вас со всех сторон, куда бы вы ни обратили свой взгляд. Целые страны, ощетинившиеся призывами, просьбами, больше напоминающими угрозы. И теперь они просят отнюдь не бельё, чтобы прикрыть наготу, и не хлеба, чтобы утолить голод. Теперь вы должны платить. Переводить деньги на указанный счёт. И чем дальше — тем больше. Тем хуже. И вот, — вы уже бессильно наблюдаете, как толпы, целые орды безымянных существ поднимаются, словно тесто, умирая тысячами, и бесконечная бойня становится патентованным зрелищем, со своими распорядителями и дельцами, превратившими происходящее в выгодный бизнес. Бедность переполнила землю. Самобичевание стало повесткой дня, а счастье — печатью распада. Удовольствие? Да как вы можете! Даже в его родном посёлке всё изменилось, и рискни теперь Кальгюйе пожертвовать бедным хорошее, чистое бельё, его бы сочли отвратительным снобом. В какой-то момент бедных стало слишком много.Чересчур.Какие - то люди.Другие.Нездешние.Просто люди — без имён, без ничего.Они роились повсюду.Всё делалось весьма тонко, — до ужаса тонко.Словно зараза распространялась по городам, заползала в дом, просачивалась сквозь двери.Никакой склеп не спасёт от могильных червей, не так ли? Это происходило повсюду, тысячами путей, бесчисленными способами, проверенными многократно и потому чрезвычайно надёжными.Они влезали к вам в кабинет сквозь щели почтовых ящиков — прося и требуя сейчас же помочь, пугая чудовищными картинами голода, взывая к жалости фотографиями большеглазых детей, провозглашая милосердие долгом, требуя и настаивая от имени и по поручению фондов и групп, прикрывающихся громкими именами, — день за днём, конверт за конвертом.Они ложились к вам на стол в образе утренней газеты, звенели в ушах проповедью вашего пастора, въедались в глаза хроникой из телевизора — бесчисленные факты нищеты, и вот вам уже никуда не деться от них.Они окружают вас со всех сторон, куда бы вы ни обратили свой взгляд. Целые страны, ощетинившиеся призывами, просьбами, больше напоминающими угрозы.И теперь они просят отнюдь не бельё, чтобы прикрыть наготу, и не хлеба, чтобы утолить голод.Теперь вы должны платить. Переводить деньги на указанный счёт.И чем дальше — тем больше. Тем хуже. И вот, — вы уже бессильно наблюдаете, как толпы, целые орды безымянных существ поднимаются, словно тесто, умирая тысячами, и бесконечная бойня становится патентованным зрелищем, со своими распорядителями и дельцами, превратившими происходящее в выгодный бизнес. Бедность переполнила землю. Самобичевание стало повесткой дня, а счастье — печатью распада. Удовольствие? Да как вы можете! Даже в его родном посёлке всё изменилось, и рискни теперь Кальгюйе пожертвовать бедным хорошее, чистое бельё, его бы сочли отвратительным снобом. В какой-то момент бедных стало слишком много.Чересчур.Какие - то люди.Другие.Нездешние.Просто люди — без имён, без ничего.Они роились повсюду.Всё делалось весьма тонко, — до ужаса тонко.Словно зараза распространялась по городам, заползала в дом, просачивалась сквозь двери.Никакой склеп не спасёт от могильных червей, не так ли? Это происходило повсюду, тысячами путей, бесчисленными способами, проверенными многократно и потому чрезвычайно надёжными.Они влезали к вам в кабинет сквозь щели почтовых ящиков — прося и требуя сейчас же помочь, пугая чудовищными картинами голода, взывая к жалости фотографиями большеглазых детей, провозглашая милосердие долгом, требуя и настаивая от имени и по поручению фондов и групп, прикрывающихся громкими именами, — день за днём, конверт за конвертом.Они ложились к вам на стол в образе утренней газеты, звенели в ушах проповедью вашего пастора, въедались в глаза хроникой из телевизора — бесчисленные факты нищеты, и вот вам уже никуда не деться от них.Они окружают вас со всех сторон, куда бы вы ни обратили свой взгляд. Целые страны, ощетинившиеся призывами, просьбами, больше напоминающими угрозы.И теперь они просят отнюдь не бельё, чтобы прикрыть наготу, и не хлеба, чтобы утолить голод.Теперь вы должны платить. Переводить деньги на указанный счёт.И чем дальше — тем больше. Тем хуже. И вот, — вы уже бессильно наблюдаете, как толпы, целые орды безымянных существ поднимаются, словно тесто, умирая тысячами, и бесконечная бойня становится патентованным зрелищем, со своими распорядителями и дельцами, превратившими происходящее в выгодный бизнес. Бедность переполнила землю. Самобичевание стало повесткой дня, а счастье — печатью распада. Удовольствие? Да как вы можете! Даже в его родном посёлке всё изменилось, и рискни теперь Кальгюйе пожертвовать бедным хорошее, чистое бельё, его бы сочли отвратительным снобом. В какой-то момент бедных стало слишком много.Чересчур.Какие - то люди.Другие.Нездешние.Просто люди — без имён, без ничего.Они роились повсюду.Всё делалось весьма тонко, — до ужаса тонко.Словно зараза распространялась по городам, заползала в дом, просачивалась сквозь двери.Никакой склеп не спасёт от могильных червей, не так ли? Это происходило повсюду, тысячами путей, бесчисленными способами, проверенными многократно и потому чрезвычайно надёжными.Они влезали к вам в кабинет сквозь щели почтовых ящиков — прося и требуя сейчас же помочь, пугая чудовищными картинами голода, взывая к жалости фотографиями большеглазых детей, провозглашая милосердие долгом, требуя и настаивая от имени и по поручению фондов и групп, прикрывающихся громкими именами, — день за днём, конверт за конвертом.Они ложились к вам на стол в образе утренней газеты, звенели в ушах проповедью вашего пастора, въедались в глаза хроникой из телевизора — бесчисленные факты нищеты, и вот вам уже никуда не деться от них.Они окружают вас со всех сторон, куда бы вы ни обратили свой взгляд. Целые страны, ощетинившиеся призывами, просьбами, больше напоминающими угрозы.И теперь они просят отнюдь не бельё, чтобы прикрыть наготу, и не хлеба, чтобы утолить голод.Теперь вы должны платить. Переводить деньги на указанный счёт.И чем дальше — тем больше. Тем хуже. И вот, — вы уже бессильно наблюдаете, как толпы, целые орды безымянных существ поднимаются, словно тесто, умирая тысячами, и бесконечная бойня становится патентованным зрелищем, со своими распорядителями и дельцами, превратившими происходящее в выгодный бизнес. Бедность переполнила землю. Самобичевание стало повесткой дня, а счастье — печатью распада. Удовольствие? Да как вы можете! Даже в его родном посёлке всё изменилось, и рискни теперь Кальгюйе пожертвовать бедным хорошее, чистое бельё, его бы сочли отвратительным снобом. В какой-то момент бедных стало слишком много.Чересчур.Какие - то люди.Другие.Нездешние.Просто люди — без имён, без ничего.Они роились повсюду.Всё делалось весьма тонко, — до ужаса тонко.Словно зараза распространялась по городам, заползала в дом, просачивалась сквозь двери.Никакой склеп не спасёт от могильных червей, не так ли? Это происходило повсюду, тысячами путей, бесчисленными способами, проверенными многократно и потому чрезвычайно надёжными.Они влезали к вам в кабинет сквозь щели почтовых ящиков — прося и требуя сейчас же помочь, пугая чудовищными картинами голода, взывая к жалости фотографиями большеглазых детей, провозглашая милосердие долгом, требуя и настаивая от имени и по поручению фондов и групп, прикрывающихся громкими именами, — день за днём, конверт за конвертом.Они ложились к вам на стол в образе утренней газеты, звенели в ушах проповедью вашего пастора, въедались в глаза хроникой из телевизора — бесчисленные факты нищеты, и вот вам уже никуда не деться от них.Они окружают вас со всех сторон, куда бы вы ни обратили свой взгляд. Целые страны, ощетинившиеся призывами, просьбами, больше напоминающими угрозы.И теперь они просят отнюдь не бельё, чтобы прикрыть наготу, и не хлеба, чтобы утолить голод.Теперь вы должны платить. Переводить деньги на указанный счёт.И чем дальше — тем больше. Тем хуже. И вот, — вы уже бессильно наблюдаете, как толпы, целые орды безымянных существ поднимаются, словно тесто, умирая тысячами, и бесконечная бойня становится патентованным зрелищем, со своими распорядителями и дельцами, превратившими происходящее в выгодный бизнес. Бедность переполнила землю. Самобичевание стало повесткой дня, а счастье — печатью распада. Удовольствие? Да как вы можете! Даже в его родном посёлке всё изменилось, и рискни теперь Кальгюйе пожертвовать бедным хорошее, чистое бельё, его бы сочли отвратительным снобом. В какой-то момент бедных стало слишком много. Чересчур. Какие-то люди. Другие. Нездешние. Просто люди — без имён, без ничего. Они роились повсюду. Всё делалось весьма тонко, — до ужаса тонко. Словно зараза распространялась по городам, заползала в дом, просачивалась сквозь двери. Никакой склеп не спасёт от могильных червей, не так ли? Это происходило повсюду, тысячами путей, бесчисленными способами, проверенными многократно и потому чрезвычайно надёжными. Они влезали к вам в кабинет сквозь щели почтовых ящиков — прося и требуя сейчас же помочь, пугая чудовищными картинами голода, взывая к жалости фотографиями большеглазых детей, провозглашая милосердие долгом, требуя и настаивая от имени и по поручению фондов и групп, прикрывающихся громкими именами, — день за днём, конверт за конвертом. Они ложились к вам на стол в образе утренней газеты, звенели в ушах проповедью вашего пастора, въедались в глаза хроникой из телевизора — бесчисленные факты нищеты, и вот вам уже никуда не деться от них. Они окружают вас со всех сторон, куда бы вы ни обратили свой взгляд. Целые страны, ощетинившиеся призывами, просьбами, больше напоминающими угрозы. И теперь они просят отнюдь не бельё, чтобы прикрыть наготу, и не хлеба, чтобы утолить голод. Теперь вы должны платить. Переводить деньги на указанный счёт. И чем дальше — тем больше. Тем хуже. И вот, — вы уже бессильно наблюдаете, как толпы, целые орды безымянных существ поднимаются, словно тесто, умирая тысячами, и бесконечная бойня становится патентованным зрелищем, со своими распорядителями и дельцами, превратившими происходящее в выгодный бизнес. Бедность переполнила землю. Самобичевание стало повесткой дня, а счастье — печатью распада. Удовольствие? Да как вы можете! Даже в его родном посёлке всё изменилось, и рискни теперь Кальгюйе пожертвовать бедным хорошее, чистое бельё, его бы сочли отвратительным снобом. В какой-то момент бедных стало слишком много.Чересчур.Какие - то люди.Другие.Нездешние.Просто люди — без имён, без ничего.Они роились повсюду.Всё делалось весьма тонко, — до ужаса тонко.Словно зараза распространялась по городам, заползала в дом, просачивалась сквозь двери.Никакой склеп не спасёт от могильных червей, не так ли? Это происходило повсюду, тысячами путей, бесчисленными способами, проверенными многократно и потому чрезвычайно надёжными.Они влезали к вам в кабинет сквозь щели почтовых ящиков — прося и требуя сейчас же помочь, пугая чудовищными картинами голода, взывая к жалости фотографиями большеглазых детей, провозглашая милосердие долгом, требуя и настаивая от имени и по поручению фондов и групп, прикрывающихся громкими именами, — день за днём, конверт за конвертом.Они ложились к вам на стол в образе утренней газеты, звенели в ушах проповедью вашего пастора, въедались в глаза хроникой из телевизора — бесчисленные факты нищеты, и вот вам уже никуда не деться от них.Они окружают вас со всех сторон, куда бы вы ни обратили свой взгляд. Целые страны, ощетинившиеся призывами, просьбами, больше напоминающими угрозы.И теперь они просят отнюдь не бельё, чтобы прикрыть наготу, и не хлеба, чтобы утолить голод.Теперь вы должны платить. Переводить деньги на указанный счёт.И чем дальше — тем больше. Тем хуже. И вот, — вы уже бессильно наблюдаете, как толпы, целые орды безымянных существ поднимаются, словно тесто, умирая тысячами, и бесконечная бойня становится патентованным зрелищем, со своими распорядителями и дельцами, превратившими происходящее в выгодный бизнес. Бедность переполнила землю. Самобичевание стало повесткой дня, а счастье — печатью распада. Удовольствие? Да как вы можете! Даже в его родном посёлке всё изменилось, и рискни теперь Кальгюйе пожертвовать бедным хорошее, чистое бельё, его бы сочли отвратительным снобом. В какой-то момент бедных стало слишком много.Чересчур.Какие - то люди.Другие.Нездешние.Просто люди — без имён, без ничего.Они роились повсюду.Всё делалось весьма тонко, — до ужаса тонко.Словно зараза распространялась по городам, заползала в дом, просачивалась сквозь двери.Никакой склеп не спасёт от могильных червей, не так ли? Это происходило повсюду, тысячами путей, бесчисленными способами, проверенными многократно и потому чрезвычайно надёжными.Они влезали к вам в кабинет сквозь щели почтовых ящиков — прося и требуя сейчас же помочь, пугая чудовищными картинами голода, взывая к жалости фотографиями большеглазых детей, провозглашая милосердие долгом, требуя и настаивая от имени и по поручению фондов и групп, прикрывающихся громкими именами, — день за днём, конверт за конвертом.Они ложились к вам на стол в образе утренней газеты, звенели в ушах проповедью вашего пастора, въедались в глаза хроникой из телевизора — бесчисленные факты нищеты, и вот вам уже никуда не деться от них.Они окружают вас со всех сторон, куда бы вы ни обратили свой взгляд. Целые страны, ощетинившиеся призывами, просьбами, больше напоминающими угрозы.И теперь они просят отнюдь не бельё, чтобы прикрыть наготу, и не хлеба, чтобы утолить голод.Теперь вы должны платить. Переводить деньги на указанный счёт.И чем дальше — тем больше. Тем хуже. И вот, — вы уже бессильно наблюдаете, как толпы, целые орды безымянных существ поднимаются, словно тесто, умирая тысячами, и бесконечная бойня становится патентованным зрелищем, со своими распорядителями и дельцами, превратившими происходящее в выгодный бизнес. Бедность переполнила землю. Самобичевание стало повесткой дня, а счастье — печатью распада. Удовольствие? Да как вы можете! Даже в его родном посёлке всё изменилось, и рискни теперь Кальгюйе пожертвовать бедным хорошее, чистое бельё, его бы сочли отвратительным снобом. В какой-то момент бедных стало слишком много.Чересчур.Какие - то люди.Другие.Нездешние.Просто люди — без имён, без ничего.Они роились повсюду.Всё делалось весьма тонко, — до ужаса тонко.Словно зараза распространялась по городам, заползала в дом, просачивалась сквозь двери.Никакой склеп не спасёт от могильных червей, не так ли? Это происходило повсюду, тысячами путей, бесчисленными способами, проверенными многократно и потому чрезвычайно надёжными.Они влезали к вам в кабинет сквозь щели почтовых ящиков — прося и требуя сейчас же помочь, пугая чудовищными картинами голода, взывая к жалости фотографиями большеглазых детей, провозглашая милосердие долгом, требуя и настаивая от имени и по поручению фондов и групп, прикрывающихся громкими именами, — день за днём, конверт за конвертом.Они ложились к вам на стол в образе утренней газеты, звенели в ушах проповедью вашего пастора, въедались в глаза хроникой из телевизора — бесчисленные факты нищеты, и вот вам уже никуда не деться от них.Они окружают вас со всех сторон, куда бы вы ни обратили свой взгляд. Целые страны, ощетинившиеся призывами, просьбами, больше напоминающими угрозы.И теперь они просят отнюдь не бельё, чтобы прикрыть наготу, и не хлеба, чтобы утолить голод.Теперь вы должны платить. Переводить деньги на указанный счёт.И чем дальше — тем больше. Тем хуже. И вот, — вы уже бессильно наблюдаете, как толпы, целые орды безымянных существ поднимаются, словно тесто, умирая тысячами, и бесконечная бойня становится патентованным зрелищем, со своими распорядителями и дельцами, превратившими происходящее в выгодный бизнес. Бедность переполнила землю. Самобичевание стало повесткой дня, а счастье — печатью распада. Удовольствие? Да как вы можете! Даже в его родном посёлке всё изменилось, и рискни теперь Кальгюйе пожертвовать бедным хорошее, чистое бельё, его бы сочли отвратительным снобом. В какой-то момент бедных стало слишком много.Чересчур.Какие - то люди.Другие.Нездешние.Просто люди — без имён, без ничего.Они роились повсюду.Всё делалось весьма тонко, — до ужаса тонко.Словно зараза распространялась по городам, заползала в дом, просачивалась сквозь двери.Никакой склеп не спасёт от могильных червей, не так ли? Это происходило повсюду, тысячами путей, бесчисленными способами, проверенными многократно и потому чрезвычайно надёжными.Они влезали к вам в кабинет сквозь щели почтовых ящиков — прося и требуя сейчас же помочь, пугая чудовищными картинами голода, взывая к жалости фотографиями большеглазых детей, провозглашая милосердие долгом, требуя и настаивая от имени и по поручению фондов и групп, прикрывающихся громкими именами, — день за днём, конверт за конвертом.Они ложились к вам на стол в образе утренней газеты, звенели в ушах проповедью вашего пастора, въедались в глаза хроникой из телевизора — бесчисленные факты нищеты, и вот вам уже никуда не деться от них.Они окружают вас со всех сторон, куда бы вы ни обратили свой взгляд. Целые страны, ощетинившиеся призывами, просьбами, больше напоминающими угрозы.И теперь они просят отнюдь не бельё, чтобы прикрыть наготу, и не хлеба, чтобы утолить голод.Теперь вы должны платить. Переводить деньги на указанный счёт.И чем дальше — тем больше. Тем хуже. И вот, — вы уже бессильно наблюдаете, как толпы, целые орды безымянных существ поднимаются, словно тесто, умирая тысячами, и бесконечная бойня становится патентованным зрелищем, со своими распорядителями и дельцами, превратившими происходящее в выгодный бизнес. Бедность переполнила землю. Самобичевание стало повесткой дня, а счастье — печатью распада. Удовольствие? Да как вы можете! Даже в его родном посёлке всё изменилось, и рискни теперь Кальгюйе пожертвовать бедным хорошее, чистое бельё, его бы сочли отвратительным снобом.";
                        var messageByte = Encoding.UTF8.GetBytes(message);
                    var bufferSend = new ArraySegment<byte>(messageByte);
                    var bufferReceive = new ArraySegment<byte>(new byte[10240]);
                    WebSocketReceiveResult result = null;

                    await apiWebsocketClient.SendAsync(bufferSend, WebSocketMessageType.Text, true,
                        CancellationToken.None);

                    Console.WriteLine("Создаем файл");
                    using (var ms = new MemoryStream())
                    {
                        while (true)
                        {
                            result = await apiWebsocketClient.ReceiveAsync(bufferReceive, CancellationToken.None);
                            await ms.WriteAsync(bufferReceive.Array, 0, result.Count, CancellationToken.None);
                            if (result.Count == 0)
                            {
                                break;
                            }
                        }

                        ms.Seek(0, SeekOrigin.Begin);

                        Console.WriteLine("Создаем файл");

                        var pcmToWave = new RawSourceWaveStream(ms, new WaveFormat(8000, 1));
                        var outpath = @"C:\WSTTS\out.wav";
                        WaveFileWriter.CreateWaveFile(outpath, pcmToWave);
                    }
                    Console.WriteLine("оп оп");
                }
            }

        }
    }
}

